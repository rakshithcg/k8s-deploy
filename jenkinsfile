pipeline {
    agent none

    stages {
        stage('Stage1:checkout') {
            agent {label 'docker-1'}
            steps {
                git branch: 'main', url: 'https://github.com/rakshithcg/k8s-deploy.git'            
            }
        }
        stage('Stage2:Build-1') {
            agent {label 'docker-1'}
            steps {
              sh 'docker build -t 581452407825.dkr.ecr.ap-south-1.amazonaws.com/docker-msb:ver$BUILD_NUMBER .'
            }
        }
        stage('Stage3:Build') {
            agent {label 'docker-1'}
            steps {
              sh 'mvn clean install'
            }
        }
        stage('Stage4:Push') {
            agent {label 'docker-1'}
            steps {
               sh 'docker push 581452407825.dkr.ecr.ap-south-1.amazonaws.com/docker-msb:ver$BUILD_NUMBER'
            }
        }
        /**stage('SonarQube Analysis Stage') {
            agent {label 'docker-1'}
            steps{
                withSonarQubeEnv('sonarqube') { 
                    sh "mvn clean verify sonar:sonar -Dsonar.projectKey=sonar-test"
                }
            }
        }
        **/        
        stage('Stage5:Deploy') {
            agent {label 'kubernetes'}
            steps {
               sh 'kubectl apply -f deploy.yaml -n health-check'
            }
        }
    }
} 
